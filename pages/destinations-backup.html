<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brazilian Destinations - Brazil Travel Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>      /* Dynamic Mapbox Popup Styling */
      .mapboxgl-popup {
        max-width: none !important;
        z-index: 1000 !important;
      }
      
      .mapboxgl-popup-content {
        padding: 0 !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        border: 1px solid #e0e0e0 !important;
        max-height: 80vh !important;
        overflow-y: auto !important;
        width: auto !important;
        min-width: 280px !important;
      }
      
      .mapboxgl-popup-close-button {
        background: rgba(0,0,0,0.5) !important;
        color: white !important;
        border-radius: 50% !important;
        width: 24px !important;
        height: 24px !important;
        font-size: 16px !important;
        line-height: 22px !important;
        text-align: center !important;
        top: 8px !important;
        right: 8px !important;
        z-index: 1001 !important;
      }
      
      .mapboxgl-popup-tip {
        border-top-color: #e0e0e0 !important;
      }
      
      /* Responsive popup sizing */
      @media (max-width: 768px) {
        .mapboxgl-popup-content {
          max-width: calc(100vw - 40px) !important;
          min-width: 250px !important;
          max-height: 70vh !important;
        }
      }
      
      @media (max-width: 480px) {
        .mapboxgl-popup-content {
          max-width: calc(100vw - 20px) !important;
          min-width: 240px !important;
          max-height: 60vh !important;
        }
      }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-map-marked-alt me-2"></i>
                Brazil Travel Planner
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="destinations.html">Destinations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="planner.html">Planner</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="weather-comparison.html">Weather Compare</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Brazilian Destinations</h1>
                <p class="lead">Discover amazing places across Brazil</p>                <!-- Mapbox Map Integration -->
                <div id="map" style="width: 100%; height: 400px; border-radius: 12px; margin-bottom: 2rem;"></div>
                <!-- End Mapbox Map -->
                  <!-- Destinations List Section -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h3><i class="fas fa-list me-2"></i>All Destinations</h3>
                        <p class="text-muted">Click on any destination to view on map or add to your planner</p>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="destinationSearch" placeholder="Search destinations...">
                            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="showAllDestinations()">Show All</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showOnlyCapitals()">Capitals Only</button>
                        </div>
                    </div>
                </div>
                  <!-- Placeholder for destination cards -->
                <div class="row" id="destinationsContainer">
                  <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading destinations...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading destinations from Brasil API...</p>
                  </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav d-lg-none">
        <a href="../index.html" class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="destinations.html" class="bottom-nav-item active">
            <i class="fas fa-map-marker-alt"></i>
            <span>Destinations</span>
        </a>
        <a href="planner.html" class="bottom-nav-item">
            <i class="fas fa-calendar"></i>
            <span>Planner</span>
        </a>
        <a href="about.html" class="bottom-nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>    </nav>
      <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <script src="../assets/js/modules/config.js"></script>
    <script src="../assets/js/modules/utils.js"></script>
    <script src="../assets/js/modules/weather.js"></script>
    <script src="../assets/js/modules/brazil.js"></script>
    <script src="../assets/js/modules/countries.js"></script>
    <script src="../assets/js/modules/holiday.js"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Custom popup styles for responsive design -->
    <style>
      .custom-popup .mapboxgl-popup-content {
        padding: 15px !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        max-width: 320px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      }
      
      .custom-popup .mapboxgl-popup-tip {
        border-top-color: #ffffff !important;
        border-bottom-color: #ffffff !important;
      }
      
      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .custom-popup .mapboxgl-popup-content {
          max-width: 280px !important;
          padding: 12px !important;
          font-size: 13px !important;
        }
        
        .custom-popup h5 {
          font-size: 14px !important;
        }
        
        .custom-popup button {
          padding: 8px 12px !important;
          font-size: 12px !important;
        }
      }
      
      /* Ensure popup stays within map bounds */
      .mapboxgl-popup {
        max-width: calc(100vw - 40px) !important;
      }
      
      .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
        border-top-color: #ffffff !important;
      }
      
      .mapboxgl-popup-anchor-top .mapboxgl-popup-tip {
        border-bottom-color: #ffffff !important;
      }
      
      .mapboxgl-popup-anchor-left .mapboxgl-popup-tip {
        border-right-color: #ffffff !important;
      }
        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip {
        border-left-color: #ffffff !important;
      }
      
      /* Destination Cards Styling */
      .destination-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .destination-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }
      
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .hover-lift:hover {
        transform: translateY(-3px);
      }
    </style>
    
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiaW50ZXJuaWNrMjAxNyIsImEiOiJjbWJ1Nnk2aWgwYnQ5MmxweDAwMTVlM20xIn0.-ACRXNq9akIVkBCzU2Gz-w';      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-47.9292, -15.7801], // Center on Brazil
        zoom: 3.5
      });
      
      map.addControl(new mapboxgl.NavigationControl());
        // Function to get responsive popup configuration
      function getResponsivePopupConfig() {
        const mapContainer = map.getContainer();
        const mapWidth = mapContainer.offsetWidth;
        const mapHeight = mapContainer.offsetHeight;
        const isMobile = window.innerWidth <= 768;
        
        return {
          // Remove fixed anchor to allow auto-positioning
          // This lets Mapbox automatically choose the best position to avoid cutoffs
          offset: isMobile ? 15 : 25, // Smaller offset on mobile
          closeButton: true,
          closeOnClick: false,
          className: 'custom-popup',
          focusAfterOpen: false, // Prevent mobile focus issues
          maxWidth: isMobile ? '280px' : '320px'
        };
      }
        // Initialize Weather API
      let weatherAPI;
      try {
        weatherAPI = new WeatherAPI();
      } catch (error) {
        console.warn('Weather API initialization failed:', error);
        weatherAPI = null;
      }
      let markersWithWeather = [];
      
      // Function to get weather icon based on condition
      function getWeatherIcon(condition) {
        const icons = {
          'Clear': '☀️',
          'Sunny': '☀️', 
          'Rain': '🌧️',
          'Cloudy': '☁️',
          'Overcast': '☁️',
          'Partially cloudy': '⛅',
          'default': '🌤️'
        };
        return icons[condition] || icons.default;
      }
      
      // Function to get temperature color
      function getTempColor(temp) {
        if (temp >= 30) return '#FF6B6B'; // Hot - Red
        if (temp >= 25) return '#FFD93D'; // Warm - Yellow  
        if (temp >= 20) return '#6BCF7F'; // Mild - Green
        return '#74C0FC'; // Cool - Blue
      }      // Enhanced destination data with travel information
      // Static popular destinations (as fallback)
      const staticDestinations = [
        { 
          name: 'Rio de Janeiro', 
          coords: [-43.1729, -22.9068],
          description: 'Famous for Christ the Redeemer, Copacabana Beach, and vibrant culture',
          highlights: ['Christ the Redeemer', 'Copacabana Beach', 'Sugarloaf Mountain', 'Carnival'],
          bestTime: 'Dec-Mar (Summer)',
          avgTemp: '25°C',
          category: 'Beach & Culture',
          estado: 'RJ'
        },
        { 
          name: 'São Paulo', 
          coords: [-46.6333, -23.5505],
          description: 'Brazil\'s largest city with amazing food, art, and nightlife',
          highlights: ['Art Museums', 'Food Scene', 'Vila Madalena', 'Japanese District'],
          bestTime: 'Apr-Oct (Dry season)',
          avgTemp: '20°C',
          category: 'Urban & Culture',
          estado: 'SP'
        },
        { 
          name: 'Brasília', 
          coords: [-47.9292, -15.7801],
          description: 'Modern capital with unique architecture and government buildings',
          highlights: ['Cathedral', 'National Congress', 'JK Bridge', 'City Park'],
          bestTime: 'May-Sep (Dry season)',
          avgTemp: '21°C',
          category: 'Architecture & Politics',
          estado: 'DF'
        },
        { 
          name: 'Salvador', 
          coords: [-38.5014, -12.9730],
          description: 'Historic colonial city with Afro-Brazilian culture and beautiful beaches',
          highlights: ['Pelourinho', 'Historic Center', 'Beaches', 'Capoeira'],
          bestTime: 'Dec-Mar (Summer)',
          avgTemp: '27°C',
          category: 'History & Beach',
          estado: 'BA'
        },
        { 
          name: 'Manaus', 
          coords: [-60.0258, -3.1190],
          description: 'Gateway to the Amazon rainforest with unique wildlife and river tours',
          highlights: ['Meeting of Waters', 'Amazon Tours', 'Opera House', 'Jungle Lodge'],
          bestTime: 'Jul-Nov (Dry season)',
          avgTemp: '28°C',
          category: 'Nature & Adventure',
          estado: 'AM'
        },
        { 
          name: 'Florianópolis', 
          coords: [-48.5482, -27.5969],
          description: 'Island paradise with 42 beaches and tech innovation hub',
          highlights: ['Joaquina Beach', 'Lagoa da Conceição', 'Surfing', 'Sand Dunes'],
          bestTime: 'Dec-Mar (Summer)',
          avgTemp: '24°C',
          category: 'Beach & Technology',
          estado: 'SC'
        },
        { 
          name: 'Foz do Iguaçu', 
          coords: [-54.5854, -25.5163],
          description: 'Home to spectacular Iguazu Falls, one of the world\'s largest waterfalls',
          highlights: ['Iguazu Falls', 'Bird Park', 'Triple Border', 'Itaipu Dam'],
          bestTime: 'Mar-May, Sep-Nov',
          avgTemp: '21°C',
          category: 'Nature & Adventure',
          estado: 'PR'
        }
      ];

      // Dynamic destinations from Brasil API
      let destinations = [];
      
      // Function to fetch cities from Brasil API
      async function fetchBrazilianCities() {
        try {
          console.log('🇧🇷 Fetching cities from Brasil API...');
          
          // First get all cities with weather stations (CPTEC)
          const citiesResponse = await fetch('https://brasilapi.com.br/api/cptec/v1/cidade');
          
          if (!citiesResponse.ok) {
            throw new Error(`CPTEC API error: ${citiesResponse.status}`);
          }
          
          const allCities = await citiesResponse.json();
          console.log(`✅ Found ${allCities.length} cities with weather data`);
          
          // Filter for major cities and capitals (top 20 most important)
          const majorCities = filterMajorCities(allCities);
          
          // Convert to destination format
          const dynamicDestinations = await Promise.all(
            majorCities.map(city => convertCityToDestination(city))
          );
          
          return dynamicDestinations.filter(dest => dest !== null);
          
        } catch (error) {
          console.warn('⚠️ Failed to fetch cities from Brasil API:', error);
          return [];
        }
      }
        // Filter for major Brazilian cities
      function filterMajorCities(cities) {
        const majorCityNames = [
          'Rio de Janeiro', 'São Paulo', 'Brasília', 'Salvador', 'Fortaleza',
          'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'Goiânia',
          'Belém', 'Porto Alegre', 'Guarulhos', 'Campinas', 'São Luís',
          'São Gonçalo', 'Maceió', 'Duque de Caxias', 'Natal', 'Florianópolis',
          'Teresina', 'Campo Grande', 'São Bernardo do Campo', 'João Pessoa',
          'Osasco', 'Santo André', 'Jaboatão dos Guararapes', 'Contagem',
          'Aracaju', 'Feira de Santana', 'Cuiabá', 'Joinville', 'Juiz de Fora',
          'Londrina', 'Aparecida de Goiânia', 'Ananindeua', 'Porto Velho',
          'Serra', 'Niterói', 'Caxias do Sul', 'Campos dos Goytacazes',
          'São José do Rio Preto', 'Ribeirão Preto', 'Uberlândia', 'Sorocaba'
        ];
        
        // More flexible matching - check if API city contains any part of major city names
        const filtered = cities.filter(city => {
          const cityNameLower = city.nome.toLowerCase();
          return majorCityNames.some(major => {
            const majorLower = major.toLowerCase();
            // Check both directions: city contains major name OR major contains city name
            return cityNameLower.includes(majorLower.split(' ')[0]) || 
                   majorLower.includes(cityNameLower) ||
                   cityNameLower === majorLower ||
                   // Special cases for compound names
                   (majorLower.includes('são') && cityNameLower.includes('são')) ||
                   (majorLower.includes('rio') && cityNameLower.includes('rio')) ||
                   // State capitals and major cities
                   ['aracaju', 'maceió', 'natal', 'joão pessoa', 'fortaleza', 'teresina', 
                    'são luís', 'belém', 'macapá', 'boa vista', 'rio branco', 'porto velho',
                    'cuiabá', 'campo grande', 'goiânia', 'palmas', 'brasília'].includes(cityNameLower);
          });
        });
        
        // If we still don't have enough, add some more based on state capitals
        if (filtered.length < 15) {
          const additionalCities = cities.filter(city => {
            const stateCaps = ['vitória', 'florianópolis', 'curitiba', 'porto alegre'];
            return stateCaps.some(cap => city.nome.toLowerCase().includes(cap.toLowerCase()));
          });
          filtered.push(...additionalCities);
        }
        
        // Remove duplicates and limit to reasonable number
        const uniqueCities = filtered.filter((city, index, self) => 
          index === self.findIndex(c => c.nome === city.nome)
        );
        
        console.log(`🏙️ Filtered to ${uniqueCities.length} major cities from ${cities.length} total`);
        return uniqueCities.slice(0, 25); // Show up to 25 cities
      }
      
      // Convert CPTEC city data to destination format
      async function convertCityToDestination(city) {
        try {
          // Get coordinates and additional info if available
          const coords = await getCityCoordinates(city.nome, city.estado);
          
          const destination = {
            name: city.nome,
            coords: coords,
            description: `Explore ${city.nome}, ${city.estado} - A vibrant Brazilian city with rich culture and attractions`,
            highlights: await getCityHighlights(city.nome),
            bestTime: getBestTimeToVisit(city.estado),
            avgTemp: '24°C', // Default, will be updated with real weather
            category: getCityCategory(city.nome),
            estado: city.estado,
            cityId: city.id // CPTEC city ID for weather data
          };
          
          return destination;
          
        } catch (error) {
          console.warn(`Failed to process city ${city.nome}:`, error);
          return null;
        }
      }
      
      // Get approximate coordinates for major Brazilian cities
      function getCityCoordinates(cityName, estado) {
        const cityCoords = {
          'Rio de Janeiro': [-43.1729, -22.9068],
          'São Paulo': [-46.6333, -23.5505],
          'Brasília': [-47.9292, -15.7801],
          'Salvador': [-38.5014, -12.9730],
          'Fortaleza': [-38.5267, -3.7319],
          'Belo Horizonte': [-43.9378, -19.9208],
          'Manaus': [-60.0258, -3.1190],
          'Curitiba': [-49.2577, -25.4244],
          'Recife': [-34.8755, -8.0476],
          'Goiânia': [-49.2532, -16.6869],
          'Belém': [-48.5044, -1.4558],
          'Porto Alegre': [-51.2177, -30.0346],
          'Florianópolis': [-48.5482, -27.5969],
          'Natal': [-35.2094, -5.7945],
          'Campo Grande': [-54.6295, -20.4697],
          'João Pessoa': [-34.8641, -7.1195],
          'Teresina': [-42.8019, -5.0892],
          'Maceió': [-35.7353, -9.6658]
        };
        
        return cityCoords[cityName] || [-47.9292, -15.7801]; // Default to Brasília center
      }
      
      // Get city highlights based on known attractions
      async function getCityHighlights(cityName) {
        const highlights = {
          'Rio de Janeiro': ['Christ the Redeemer', 'Copacabana Beach', 'Sugarloaf Mountain', 'Carnival'],
          'São Paulo': ['Art Museums', 'Food Scene', 'Vila Madalena', 'Japanese District'],
          'Brasília': ['Cathedral', 'National Congress', 'JK Bridge', 'City Park'],
          'Salvador': ['Pelourinho', 'Historic Center', 'Beaches', 'Capoeira'],
          'Manaus': ['Meeting of Waters', 'Amazon Tours', 'Opera House', 'Jungle Lodge'],
          'Florianópolis': ['Joaquina Beach', 'Lagoa da Conceição', 'Surfing', 'Sand Dunes'],
          'Fortaleza': ['Beaches', 'Dragão do Mar', 'Historic Center', 'Nightlife'],
          'Belo Horizonte': ['Pampulha', 'Central Market', 'Museums', 'Mountains'],
          'Curitiba': ['Botanical Garden', 'Opera de Arame', 'Parks', 'Architecture'],
          'Recife': ['Historic Center', 'Beaches', 'Frevo', 'Carnival'],
          'Porto Alegre': ['Historic Center', 'Parks', 'Culture', 'Gaucho Traditions'],
          'Belém': ['Ver-o-Peso Market', 'Amazon Culture', 'Historic Center', 'Cuisine']
        };
        
        return highlights[cityName] || ['Historic Sites', 'Local Culture', 'Regional Cuisine', 'Natural Beauty'];
      }
      
      // Get best time to visit based on region
      function getBestTimeToVisit(estado) {
        const northStates = ['AM', 'RO', 'AC', 'RR', 'PA', 'AP', 'TO'];
        const northeastStates = ['MA', 'PI', 'CE', 'RN', 'PB', 'PE', 'AL', 'SE', 'BA'];
        const southStates = ['RS', 'SC', 'PR'];
        
        if (northStates.includes(estado)) {
          return 'Jul-Nov (Dry season)';
        } else if (northeastStates.includes(estado)) {
          return 'May-Sep (Dry season)';
        } else if (southStates.includes(estado)) {
          return 'Dec-Mar (Summer)';
        } else {
          return 'Apr-Oct (Mild weather)';
        }
      }
      
      // Categorize cities
      function getCityCategory(cityName) {
        const categories = {
          'Rio de Janeiro': 'Beach & Culture',
          'São Paulo': 'Urban & Culture', 
          'Brasília': 'Architecture & Politics',
          'Salvador': 'History & Beach',
          'Manaus': 'Nature & Adventure',
          'Florianópolis': 'Beach & Technology',
          'Fortaleza': 'Beach & Culture',
          'Belo Horizonte': 'Culture & Mountains',
          'Curitiba': 'Urban & Parks',
          'Recife': 'History & Beach',
          'Porto Alegre': 'Culture & Traditions',
          'Belém': 'Culture & Nature'
        };
        
        return categories[cityName] || 'Culture & Tourism';
      }
      
      // Initialize destinations (try API first, fallback to static)
      async function initializeDestinations() {
        try {
          console.log('🚀 Initializing destinations...');
          
          const dynamicDestinations = await fetchBrazilianCities();
          
          if (dynamicDestinations.length > 0) {
            destinations = dynamicDestinations;
            console.log(`✅ Using ${destinations.length} destinations from Brasil API`);
          } else {
            destinations = staticDestinations;
            console.log(`⚠️ Using ${destinations.length} static destinations as fallback`);
          }
          
        } catch (error) {
          console.error('❌ Error initializing destinations:', error);
          destinations = staticDestinations;
        }
      }// Create enhanced markers with detailed popups and weather overlay
      async function createMarkersWithWeather() {
        for (const dest of destinations) {
          try {
            // Only fetch weather if API is available
            if (weatherAPI && weatherAPI.apiKey) {
              // Fetch current weather for each destination
              const weatherData = await weatherAPI.getCurrentWeather(`${dest.name},Brazil`, 'metric');
              const currentWeather = weatherData.currentConditions;
              const temp = Math.round(currentWeather.temp);
              const condition = currentWeather.conditions;
              const icon = getWeatherIcon(condition);
            
            // Create custom marker with weather overlay
            const markerElement = document.createElement('div');
            markerElement.className = 'custom-marker-weather';
            markerElement.innerHTML = `
              <div style="position: relative;">
                <div style="
                  background-color: ${getTempColor(temp)};
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  border: 2px solid white;
                  cursor: pointer;
                  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 10px;
                  font-weight: bold;
                  color: white;
                ">
                  ${temp}°
                </div>
                <div style="
                  position: absolute;
                  top: -8px;
                  right: -8px;
                  font-size: 12px;
                  filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
                ">
                  ${icon}
                </div>
              </div>
            `;            // Enhanced popup content with live weather - Fixed styling
            const popupContent = `
              <div style="width: 280px; min-height: 200px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.4;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                  <h5 style="margin: 0; color: #007BFF; font-size: 18px; font-weight: 600; flex: 1;">${dest.name}</h5>
                  <div style="text-align: right; margin-left: 10px; flex-shrink: 0;">
                    <div style="font-size: 20px; margin-bottom: 2px;">${icon} ${temp}°C</div>
                    <div style="font-size: 11px; color: #666; white-space: nowrap;">${condition}</div>
                  </div>
                </div>
                
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #555; line-height: 1.4;">${dest.description}</p>
                
                <div style="margin-bottom: 10px;">
                  <span style="background: #e7f3ff; color: #0066cc; padding: 3px 8px; border-radius: 15px; font-size: 11px; font-weight: 500;">${dest.category}</span>
                </div>
                
                <div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                  <div style="margin-bottom: 4px;">
                    <strong style="font-size: 12px; color: #333;">🌤️ Current:</strong> 
                    <span style="font-size: 12px; color: #007BFF;">${temp}°C, ${condition}</span>
                  </div>
                  <div>
                    <strong style="font-size: 12px; color: #333;">📅 Best Time:</strong> 
                    <span style="font-size: 12px;">${dest.bestTime}</span>
                  </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                  <strong style="font-size: 12px; color: #333; display: block; margin-bottom: 6px;">✨ Top Highlights:</strong>
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${dest.highlights.map(h => `<span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${h}</span>`).join('')}
                  </div>
                </div>
                
                <button onclick="addToPlanner('${dest.name}')" 
                        style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; 
                               padding: 10px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; 
                               cursor: pointer; width: 100%; transition: all 0.2s; box-shadow: 0 2px 4px rgba(40,167,69,0.2);"
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(40,167,69,0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(40,167,69,0.2)'">
                  <i class="fas fa-plus"></i> Add to My Planner
                </button>              </div>
            `;            // Create popup with responsive positioning
            const popupConfig = getResponsivePopupConfig();
            const popup = new mapboxgl.Popup(popupConfig)
            .setHTML(popupContent)
            .setMaxWidth(popupConfig.maxWidth);

            const marker = new mapboxgl.Marker(markerElement)
              .setLngLat(dest.coords)
              .setPopup(popup)
              .addTo(map);
                markersWithWeather.push({marker, dest, weather: currentWeather});
            
            } else {
              // No weather API available, create basic marker
              console.warn(`Weather API not available for ${dest.name}`);
              createBasicMarker(dest);
            }
            
          } catch (error) {
            console.warn(`Could not fetch weather for ${dest.name}:`, error);
            // Fallback to basic marker without weather
            createBasicMarker(dest);
          }
        }
      }
      
      // Helper function to create basic markers without weather
      function createBasicMarker(dest) {
            const markerElement = document.createElement('div');
            markerElement.className = 'custom-marker';
            markerElement.style.cssText = `
              background-color: #007BFF;
              width: 20px;
              height: 20px;
              border-radius: 50%;
              border: 2px solid white;
              cursor: pointer;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;            const popupContent = `
              <div style="width: 280px; min-height: 180px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.4;">
                <h5 style="margin: 0 0 10px 0; color: #007BFF; font-size: 18px; font-weight: 600;">${dest.name}</h5>
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #555; line-height: 1.4;">${dest.description}</p>
                
                <div style="margin-bottom: 10px;">
                  <span style="background: #e7f3ff; color: #0066cc; padding: 3px 8px; border-radius: 15px; font-size: 11px; font-weight: 500;">${dest.category}</span>
                </div>
                
                <div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                  <div style="margin-bottom: 4px;">
                    <strong style="font-size: 12px; color: #333;">🌡️ Avg Temp:</strong> 
                    <span style="font-size: 12px;">${dest.avgTemp}</span>
                  </div>
                  <div>
                    <strong style="font-size: 12px; color: #333;">📅 Best Time:</strong> 
                    <span style="font-size: 12px;">${dest.bestTime}</span>
                  </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                  <strong style="font-size: 12px; color: #333; display: block; margin-bottom: 6px;">✨ Top Highlights:</strong>
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${dest.highlights.map(h => `<span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${h}</span>`).join('')}
                  </div>
                </div>
                
                <button onclick="addToPlanner('${dest.name}')" 
                        style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; 
                               padding: 10px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; 
                               cursor: pointer; width: 100%; transition: all 0.2s; box-shadow: 0 2px 4px rgba(40,167,69,0.2);"
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(40,167,69,0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(40,167,69,0.2)'">
                  <i class="fas fa-plus"></i> Add to My Planner
                </button>              </div>
            `;            // Create fallback popup with responsive positioning
            const fallbackPopupConfig = getResponsivePopupConfig();
            const fallbackPopup = new mapboxgl.Popup(fallbackPopupConfig)
            .setHTML(popupContent)
            .setMaxWidth(fallbackPopupConfig.maxWidth);            const marker = new mapboxgl.Marker(markerElement)
              .setLngLat(dest.coords)
              .setPopup(fallbackPopup)
              .addTo(map);
      }      // Initialize the map with markers when page loads
      map.on('load', async function() {
        // First initialize destinations from API
        await initializeDestinations();
        
        // Then create markers and populate cards
        createMarkersWithWeather().catch(error => {
          console.warn('Error creating markers:', error);
          // Create basic markers as fallback
          destinations.forEach(dest => createBasicMarker(dest));
        });
        
        // Also populate the destination cards below the map
        populateDestinationCards();
      });      // Function to populate destination cards below the map
      function populateDestinationCards() {
        const container = document.getElementById('destinationsContainer');
        if (!container) return;        // Show data source info
        const isApiData = destinations.some(dest => dest.cityId); // API data has cityId
        const dataSourceInfo = isApiData 
          ? `<div class="alert alert-success mb-4"><i class="fas fa-check-circle me-2"></i>Showing ${destinations.length} destinations from Brasil API (Real-time data)</div>`
          : `<div class="alert alert-info mb-4"><i class="fas fa-info-circle me-2"></i>Showing ${destinations.length} popular destinations (Static data - API fallback)</div>`;

        const cardsHtml = destinations.map(dest => {
          const highlightsHtml = dest.highlights.map(h => 
            `<span class="badge bg-light text-dark me-1 mb-1">${h}</span>`
          ).join('');

          return `
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card h-100 destination-card hover-lift">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title text-primary">${dest.name}</h5>
                    <span class="badge bg-info">${dest.category}</span>
                  </div>
                  
                  <p class="card-text text-muted small">${dest.description}</p>
                  
                  <div class="mb-3">
                    <div class="row text-center">
                      <div class="col-6">
                        <small class="text-muted d-block">Best Time</small>
                        <strong class="small">${dest.bestTime}</strong>
                      </div>
                      <div class="col-6">
                        <small class="text-muted d-block">Avg Temp</small>
                        <strong class="small">${dest.avgTemp}</strong>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <small class="text-muted d-block mb-2">Top Highlights:</small>
                    <div>${highlightsHtml}</div>
                  </div>
                  
                  <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="focusOnMap(${dest.coords[0]}, ${dest.coords[1]})">
                      <i class="fas fa-map-marker-alt me-1"></i>View on Map
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="addToPlanner('${dest.name}')">
                      <i class="fas fa-plus me-1"></i>Add to Planner
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;        }).join('');

        container.innerHTML = dataSourceInfo + cardsHtml;
        console.log('✅ Destination cards populated successfully');
      }

      // All destination data and templating is now handled by main.js for consistency
      // The map will be populated by main.js destination data
      
      // Function to focus map on specific destination
      window.focusOnMap = function(lng, lat) {
        map.flyTo({
          center: [lng, lat],
          zoom: 10,
          duration: 2000
        });
      };

      // Add mobile responsiveness improvements
      function handleMobileMap() {
        // Adjust map height and controls for mobile
        if (window.innerWidth <= 768) {
          document.getElementById('map').style.height = '300px';
          // Add touch gestures for mobile
          map.scrollZoom.disable();
          map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
        } else {
          document.getElementById('map').style.height = '400px';
          map.scrollZoom.enable();
        }
      }
      
      // Apply mobile adjustments on load and resize
      window.addEventListener('load', handleMobileMap);
      window.addEventListener('resize', handleMobileMap);
      
      // Handle map resize events to update popup positioning
      map.on('resize', () => {
        // Close any open popups on resize to prevent positioning issues
        const popups = document.querySelectorAll('.mapboxgl-popup');
        popups.forEach(popup => {
          const closeButton = popup.querySelector('.mapboxgl-popup-close-button');
          if (closeButton) closeButton.click();
        });
      });      // DOMContentLoaded is handled by main.js for consistent initialization
      // populateDestinationCards is no longer needed as main.js handles all destination rendering
        // Add to planner function for destination buttons
      window.addToPlanner = function(destinationName) {
        // Simple implementation - you can enhance this
        alert(`${destinationName} added to your planner! Visit the Planner page to see your selections.`);
        
        // Optional: Store in localStorage for persistence
        const savedDestinations = JSON.parse(localStorage.getItem('selectedDestinations') || '[]');
        if (!savedDestinations.find(dest => dest.name === destinationName)) {
          savedDestinations.push({name: destinationName, addedDate: new Date().toISOString()});
          localStorage.setItem('selectedDestinations', JSON.stringify(savedDestinations));
        }
      };
      
      // Store all cities for search functionality
      let allCitiesFromAPI = [];
      
      // Search and filter functions
      window.showAllDestinations = async function() {
        if (allCitiesFromAPI.length === 0) {
          console.log('Loading all cities...');
          try {
            const response = await fetch('https://brasilapi.com.br/api/cptec/v1/cidade');
            allCitiesFromAPI = await response.json();
          } catch (error) {
            console.warn('Failed to load all cities:', error);
            return;
          }
        }
        
        // Convert first 50 cities to destinations
        const allDestinations = await Promise.all(
          allCitiesFromAPI.slice(0, 50).map(city => convertCityToDestination(city))
        );
        
        destinations = allDestinations.filter(dest => dest !== null);
        populateDestinationCards();
        updateMapMarkers();
      };
      
      window.showOnlyCapitals = function() {
        const capitals = [
          'Rio de Janeiro', 'São Paulo', 'Brasília', 'Salvador', 'Fortaleza',
          'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'Goiânia',
          'Belém', 'Porto Alegre', 'Natal', 'Florianópolis', 'Teresina',
          'Campo Grande', 'João Pessoa', 'Aracaju', 'Maceió', 'São Luís',
          'Cuiabá', 'Vitória', 'Macapá', 'Boa Vista', 'Rio Branco', 'Porto Velho', 'Palmas'
        ];
        
        destinations = destinations.filter(dest => 
          capitals.some(cap => dest.name.toLowerCase().includes(cap.toLowerCase()))
        );
        populateDestinationCards();
        updateMapMarkers();
      };
      
      // Search functionality
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('destinationSearch');
        const searchBtn = document.getElementById('searchBtn');
        
        if (searchInput && searchBtn) {
          searchInput.addEventListener('input', performSearch);
          searchBtn.addEventListener('click', performSearch);
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
          });
        }
      });
      
      function performSearch() {
        const searchTerm = document.getElementById('destinationSearch').value.toLowerCase();
        
        if (!searchTerm) {
          // Reset to original destinations
          initializeDestinations().then(() => {
            populateDestinationCards();
            updateMapMarkers();
          });
          return;
        }
        
        const filteredDestinations = destinations.filter(dest =>
          dest.name.toLowerCase().includes(searchTerm) ||
          dest.estado.toLowerCase().includes(searchTerm) ||
          dest.category.toLowerCase().includes(searchTerm) ||
          dest.highlights.some(h => h.toLowerCase().includes(searchTerm))
        );
        
        const tempDestinations = destinations;
        destinations = filteredDestinations;
        populateDestinationCards();
        destinations = tempDestinations; // Restore for next search
      }
      
      function updateMapMarkers() {
        // Clear existing markers
        markersWithWeather.forEach(marker => marker.marker.remove());
        markersWithWeather = [];
        
        // Create new markers
        createMarkersWithWeather().catch(error => {
          console.warn('Error updating markers:', error);
          destinations.forEach(dest => createBasicMarker(dest));
        });
      }
    </script>
    <script src="../assets/js/main.js"></script>
</body>
</html>